import type { NextApiRequest, NextApiResponse } from 'next';
import jwt from 'jsonwebtoken';

// Server-side only - SVG paths and room data (protected from client)
const PROTECTED_ROOM_DATA = {
  bedroom: {
    image: "/lovable-uploads/bedroom6.jpg",
    svgPath: "M1256.66,472.47l8.58.42.13-100.16-8.85-.14.14,99.88ZM1278.79,372.45l-11.06.14v100.3l10.92.97v-12.32h1.11v-78.02l-.97-.28v-10.79ZM1224.3,372.41l1.08-2.16v-46.54l-.27-14.07-.54-2.44,22.19-.27,33.28-1.35-.07-80.83c-3.76,5.01-11.14,10.59-26.11,16.05-18.76,6.84-31.66,3.32-43.2-2.15-11.53-5.47-23.46-16.81-26.39-33.42s2.54-29.32,9.77-40.27c7.23-10.95,17.01-17.01,28.15-22.48s22.09-4.3,35.57-2.35c10.8,1.56,19.21,9.14,22.14,12.1l-.13-152.12-63.23.76-542.05,93.55v226.7l33.36-1.25.41-5.36,3.71.82.21,4.12,40.62,1.24-.62,2.68v46.39h-18.76l-.2,59.84,6.23-.64h11.9l12.72-.27,7.03,1.35,5.14.54.27-37.07.27-24.35.81-9.47,1.35-5.14s2.98-7.31,10.28-7.03c7.31.27,118.78-.81,118.78-.81l216.72-1.89,67.91-.27s5.41-.27,5.14,7.58c-.27,7.85-.54,74.68-.54,74.68l.27,48.7,19.75-4.33s-.81-5.68.81-5.68,23.81-.81,28.95,1.08c5.14,1.89,1.62,4.87,1.62,4.87l5.14.54-.27-100.11-29.22.54h.02,0ZM790.57,259.27l-1.43.1-34.63,2.04-2.45-.31.1-43.42,3.68-.41,32.28-2.86,2.45.82v44.03h0ZM1077.89,137.09s5.4-21.36,34.86-24.3c29.46-2.95,46.64,55.48-6.38,65.05,0,0-16.69,1.47-26.76-13.75,0,0-7.36-9.57-1.72-27ZM971.79,154.19s12.61-1.96,13.31,16.12-28.31,19.76-28.73.56c0,0-1.26-14.71,15.42-16.68ZM807.22,176.92l30.34-3.27,1.84.82.1,45.67-30.45,2.55-1.94-1.12.1-44.65h.01ZM842.98,286.75l-.31,2.15-3.06.31-10.83.1-23.29,1.33-3.27-.82v-52.62l32.9-2.35h7.15l.72,1.33-.1,9.6.1,40.97h-.01ZM942.28,224.05l-22.25,1.9-40.99,3.07-7.03.59-6.59-.44-.15-43.92-.29-34.55.29-5.42,6.29-1.02,33.96-4.25,5.27-.29,5.56-.88,15.08-1.9,10.1-1.17,1.76,2.05v56.07l.15,29.13-1.17,1.02h.01ZM991.07,250.66l-31.39,2.44-6.22-.81v-49.51l36.17-3.04,1.86.66.22,49.26-.64,1.02v-.02h0ZM1060.87,225.77l-51.95,3.79-3.79-1.08.27-65.21,53.57-5.68,1.89,1.35v66.83h.01ZM1171.26,290.43l-81.44,2.98h-11.09l-4.6-.81v-93.35l94.7-8.12,2.71,1.08.27,94.7-.54,3.52h-.01ZM689.49,369.98l-.2,70.01,6.05-2.37,8.12-3.25,1.89.82h.01l-.41-65.21h-15.46ZM674.48,369.43v63.32l5.17.81,1.08,5.95,6.49.42-.2-70.37-12.54-.13h0ZM715.88,369.77l.2,61.61,10.1-.79,5.42-.82.33-.03-.58-60.38-15.47.41ZM418.21,519.42l-10.9.59,3.79,22.5,10.48,1.49-3.37-24.58h0ZM390.66,539.61l7.46,1.06,1.27-20.8-6.13.14-2.6,19.6h0ZM378.92,488.04h-1.5l-.44,27.04-.13,22.57,9.01,1.28,2.77-18.92-5.23-1.04-2.24-1.2-.75-2.39-.74-7.02v-17.18l-.75-3.14h0ZM367.86,382.56l5.68,18.38.6-19.58.59-7.02-7.9-23.49-.42,40.66,4.74,13.01-3.29-21.96h0ZM371.45,488.34h-6.04l-.51,49.94,4.99-.55,1.56-49.39h0ZM669.76,322.12l4.73-.99V94.42l-226.06-54.61-75.35,17.97L111.79.57.13.11v611.71l66.16-9.65.15-55.61-.6-94.19.45-84.55V33.87c.6-1.96,1.36-.15,3.01-.45s1.66,1.81,5.12.9c3.47-.9,4.67,3.77,7.23,2.26,2.56-1.51,1.96,1.36,4.07.45,2.11-.9,3.92,1.51,6.18.9,2.26-.6,1.21,4.52,4.67,1.81,3.47-2.71,3.01.15,3.77.3.75.15,1.66.9,3.32,0,1.66-.9,2.11,1.66,4.07,1.05,1.96-.6,3.16,1.81,5.43,1.05,2.26-.75,3.16,3.01,4.67,1.81,1.51-1.21,2.71.75,3.32.15.6-.6,1.96.6,2.86,1.36.9.75,3.84.62,5.97.27,2.13-.36,2.13,4.98.36,10.32-1.78,5.34-.71,20.99-.71,20.99l170.02,29.52v-9.96s-1.6-15.04-.03-17.4,4.56.47,6.3,0c1.73-.47,4.09,2.52,5.98,1.57,1.89-.94,3.78,2.52,4.56.79s3.78.63,8.5.47c4.72-.16,4.72,4.41,7.87,2.83s4.72,1.89,8.03,1.26,3.31,2.83,5.19,1.73c1.89-1.1,3.62.63,6.61.63s3.31,2.36,5.51,1.42,2.83,2.36,5.19,1.26c2.36-1.1,4.88,1.57,4.88,1.57l4.09.94c1.1-2.2,3.31-.31,3.31-.31,2.99,0,5.67.47,4.56,4.72-1.1,4.25-5.78,3.06-5.78,3.06l-6.46-2.04-1.36,8.5.68,62.59v136.41l-.44,42.83,8.64,20.85,5.98-17.78-3.29,18.38,4.33,10.76.75-3.14.6-18.53.45,13.75,4.93-17.78-1.05,28.09.9-3.44,1.94-27.04-.3,21.37,3.88-13.9-.15,9.26,3.14-15.84-2.09,17.33,13.9-46.76-.6,6.13,2.24-6.57c-1.64,15.54-10.76,53.64-10.76,53.64l2.84-6.28-5.68,25.7,7.02-7.77-5.08,8.96,7.62-3.14c-1.34,2.24-7.02,5.53-7.02,5.53,0,0-4.03,1.79-5.08,8.22-1.05,6.42-5.68,18.38-5.68,18.38,14.04-.75,19.57.75,19.57.75l1.64.9-.15,18.97c18.23-15.09,24.5,1.2,24.5,1.2-10.76-11.36-15.24-2.39-15.24-2.39l3.44,1.49c15.39-3.59,21.07,16.14,21.07,16.14-8.82-16.29-17.78-14.04-17.78-14.04,5.83,3.29,13.9,14.64,13.9,14.64,0,0-5.98-5.53-8.37-6.87-2.39-1.34-3.14-4.63-7.47-6.42s-8.07,4.78-8.07,4.78c8.52-3.59,13.45,10.31,13.45,10.31l3.59,2.69-2.69-.3c5.08,21.81,1.34,30.03,1.34,30.03,0-10.24-1.37-17.76-2.86-22.91-.09,8-.42,32.88-1.17,37.26-.9,5.23-5.38,4.78-5.38,4.78l4.23,25.92,11.99,1.7c.46-5.21,1.07-6.59,1.07-6.59,3.37-1.23,28.49-5.51,28.49-5.51,0,0,.61-.92.61-3.52s.46-5.05,1.68-7.81c1.23-2.76,9.04-19.3,9.04-19.3,0,0,5.51-13.94,15.16-25.42,9.65-11.49,22.82-13.63,24.81-13.63s5.67-1.84,5.67-1.84c0,0,2.3-2.14,5.51-2.76,3.22-.61,12.56-2.91,15.93-3.83,3.37-.92,7.2-.46,10.57-1.38s6.59.15,9.04-.92c2.45-1.07,6.59.61,9.04-.77s8.58.31,11.49-1.38c2.91-1.68,7.81-2.45,7.81-2.45,5.36-3.22,7.81-1.07,7.81-1.07,3.22-1.53,5.67-.15,5.67-.15,4.44-1.68,6.43.15,6.43.15,3.68-.92,7.05-.15,10.26-.15s14.09-.15,23.43-4.59c9.34-4.44,17.21-2.64,17.21-2.64l.77-6.58c1.16-1.55,8.21-1.54,8.21-1.54v-63.32l-5.11-.12.39-47.19h0ZM609.83,377.23l-5.04.76-85.43,1.26.25-179.17,1.76-1.01,88.45,11.84v166.32h0ZM402.92,541.35l1.42.2-1.22-5.55-.2,5.35ZM427.18,472.8l.83.64c-1.39-3.81-2.62-5.57-2.62-5.57l-4.18-1.34,1.64,6.42,4.33-.15h0ZM295.74,534.66l.08,12.28-4.77.47.16-12.04,4.54-.7h-.01ZM286.82,535.83l-.16,12.12-15.33,1.8v-12.2l15.49-1.72ZM266.8,538.18v12.2l-16.81,2.5s4.93-1.96,5.94-13.61l10.87-1.09Z",
    wallMasks: {
      left: "/assets/images/bedroom/bedroom6/left-wall.svg",
      right: "/assets/images/bedroom/bedroom6/right-wall.svg",
      window: "/assets/images/bedroom/bedroom6/window.svg"
    }
  },
  living: {
    image: "/lovable-uploads/living-room.jpg", 
    svgPath: "M21.93,0h1258.07v159.18l-1.94,5.32-5.07,7.49-6.04,3.62-.72,8.46,2.17,9.18-2.17,28.99-.48,22.47,7.01,7.25-.48,7.73-2.17,9.91,2.42,5.56,2.9,8.21,4.59.72v372.32l-141.34-67.17h-23.19l-2.9-9.66-1.93-12.08,2.17-7.97,3.62-9.91-1.45-8.94-3.14-3.62-4.59,1.45-3.62,6.28-2.9,7.73-2.66-1.93-.48-222.76,36.97.24,19.09-3.62v-56.3l-9.18-2.42-37.93-.24-31.41.97-36.48,3.87.48,54.6.48,2.9,51.46.24v221.07s-4.83,3.38-4.83,3.38l-7.25-.48-21.02-1.21-18.85,1.45-4.11-8.94-3.87-5.56-4.35-1.21-2.17,4.35,1.21,8.21,3.14,7.97,2.17,7.25-1.69,5.32-5.32,13.29-2.66,5.32h-17.64l1.69-109.45-43.25-16.19-16.67.97-9.42-9.42,6.77-17.15-14.5,3.38-27.06,4.11h-22.47l-14.26-2.17-12.56-4.59-13.05-5.56v16.91l-34.79.48-10.15-3.87v-7.25l-40.35-.24-4.59,3.38-10.63-3.38-12.81.97-3.87-3.62-3.87,1.93-8.21.72-5.56-2.9-6.04-1.69-5.56,4.59-16.19.72-4.35,7.73-24.16-.24-5.07-15.95-14.26,7.49-30.68,2.66-24.16.97v-8.7l-3.38.24-12.08,5.8-12.32-3.38-6.28-2.42,3.87,11.84h-12.81l-22.23-1.45-29.48-5.32h-3.62l7.01,20.3-28.27,1.69-37.21,17.64,4.59,108.48h-53.64l-1.21-118.15-2.42-1.69,2.66-7.01,3.38-6.52,6.04,6.77-.48-8.7,6.28-7.97,5.56-10.39,12.08-7.97,6.52-8.94,6.04-5.56-.97-12.56,5.8-4.83,6.04-6.52,3.38-3.38-.97-5.32,3.62-2.17,1.93-4.35.48-9.18,4.11-4.35,4.83-4.11.97-2.66-5.8-3.14-6.04-.72,2.66-7.49-.24-7.01-14.98,11.11-6.52,7.97-7.01,3.87,2.17-9.66,5.07-9.18-.48-8.94-4.59-3.62-2.66,5.32-3.62,7.73-4.35,13.53-13.05,19.33-2.42-7.25-.48-8.21,2.66-7.01,4.35-2.66-3.14-10.39,4.11-3.38,2.66-4.35-4.83-1.21,1.21-8.21,1.45-7.25,5.07-4.11-2.42-1.93-5.32.97.72-4.35-8.94-5.32,1.21-5.8-8.46,7.25-4.35,7.25-6.04,10.39-2.9-4.59-1.45-6.28,2.66-8.46-2.17-8.21.72-6.77-3.62,1.93-3.87,5.07-1.69,10.87-1.69,3.62-.72,10.15-6.77,1.21-3.62,3.62-4.11-1.45-.24-8.46-2.42-13.05-2.17-12.08-4.59-7.73.72,7.73-4.11,6.04,3.14,9.66-4.59,1.21v4.11l5.32,5.32.97,4.35-2.66,6.28-9.42-11.36v-7.49l-5.32-7.25-.24-5.56-12.56-8.94-3.14,3.38,3.38,4.35-5.32,4.11-3.87-2.17-4.83-1.21-5.56,6.04-1.21,4.35,7.97,7.01h3.38l2.42,3.62-1.93,3.62,4.11,13.05-5.56-2.9-4.83-1.21-6.52.72,6.28,6.77-5.32,2.17-2.17-.97-5.07-2.42-3.87-.72-3.38,5.56v9.18l9.42,9.66-.72,4.83,1.45,7.01,3.38,2.17,5.07,5.32-6.77,4.59,11.36,4.59,5.32,3.38-5.56,2.42-2.17,3.62,9.91-1.93v6.04l3.14,1.21,4.83,5.07-2.17,1.69-6.04,2.42-3.87,4.59.48,6.04,10.63-4.59,6.52-4.83,2.9,2.9-7.25,6.04-.48,7.25-11.6.97-5.32,4.83h10.63l9.91,6.04,7.25,12.56,7.97,8.21,1.93,6.28-4.59,9.42-1.21,57.74-60.4-7.73-1.21-6.28-2.66-7.97-4.35-5.32-7.25-7.25-7.73-5.4-7.97-.89h-20.54v-2.42l-4.35-4.83-8.21-6.04-7.01-3.38-10.15-2.66-14.01-3.62-15.14-2.58-22.87-.64-24.48,1.93-19.65,3.87-12.89,2.9-9.34,2.9-17.07,7.73-12.56,7.73L21.93,0M283.6,341.03l11.36,11.84h5.8l-2.66-5.92-14.5-5.92ZM352.21,459.18l3.87-7.25-3.38-8.7-3.62,5.32-5.56,2.17-2.17,7.25,3.62,8.7h7.73l-.48-7.49ZM1112.08,541.45h-2.9l-2.9,4.47-3.26,7.25-.97,3.62,8.58,5.44,1.45-8.82v-11.96ZM1030.05,541.45h-2.17v8.58l3.99,6.4,5.68,3.38h1.81l-1.21-4.23-3.74-8.7-4.35-5.44ZM789.17,90.36c-56.84,0-102.93,46.08-102.93,102.93s46.08,102.93,102.93,102.93,102.93-46.08,102.93-102.93-46.08-102.93-102.93-102.93ZM610.86,190.87c-56.84,0-102.93,46.08-102.93,102.93s46.08,102.93,102.93,102.93,102.93-46.08,102.93-102.93-46.08-102.93-102.93-102.93Z",
    wallMasks: {
      front: "/assets/images/living-room/front-wall.svg",
      left: "/assets/images/living-room/left-wall.svg",
      right: "/assets/images/living-room/right-wall.svg"
    }
  },
  kitchen: {
    image: "/lovable-uploads/kitchen.jpg",
    svgPath: "M0,32.99V0h260.07l167.99,183.28,590.7,3.29,31.84-16.47,229.4-1.1v310.65l-18.83,1.45,3.38-281.88-142.71-1.29-4.19,305.4,52.19.64,2.26,5.15,4.51,6.77,6.44,4.51,1.29,5.48h-139.81l-20.94-7.09-2.58-53.48,2.58-27.06v-9.5l-42.64-3.5-86.38-.36v-31.65h-24.16v6.77l-6.52.48v24.4l-5.32,1.21v-3.14l2.17-.48.97-3.14-1.21-3.38-3.14-1.93v-13.53l-12.56.24v12.32l-2.66-2.66-3.14-.48-3.38,2.66-2.66-2.42-4.11,1.69-1.93,4.11,1.45,4.59,4.59,4.11h-145.69l-35.28-.48-1.21-39.87v-14.01l-4.11-11.6-3.38-6.28-6.04-3.38-5.56,1.21-4.83,4.83-3.87,9.18-1.69,14.74v34.07l-.48,7.25,2.9.72.97-2.17.24-16.43,21.74.97v21.5l-51.46.24-8.21.24-160.43.24,3.14-3.62,1.93-3.62-4.59-3.87-2.42-2.66-6.77.97-2.17,2.66-6.04.72-.48,4.59,5.32,5.07h-126.12l-27.06,2.9-3.38-251.76L0,32.99M646.92,400.97v-30.6l-2.26-8.7-3.22-6.44-3.87-2.26h-3.54l-3.54,3.7-3.38,5.8-2.26,5.48v32.38l22.07.64ZM793.98,183.39v40.11l-10.31,2.58v5.41l24.6.05-.28-5.94-2.58-2.9h-8.38v-39.3h-3.06ZM702.97,183.39l-.32,39.46-9.66,2.74-.13,5.64,24.12.11-.15-6.23-2.74-2.09h-8.21v-39.62h-2.9ZM611.16,183.39l-.16,39.3-8.7.16-2.42,2.42-.06,5.26,24.08.18-.17-5.28-3.06-2.26-6.93-.81v-38.98h-2.58ZM267.99,228.01l1.21,141.83,1.81,1.81h300.68v-36.93l130.15-1.61,1.61,38.54h297.99l1.61-139.69-299.92-.64-435.14-3.3ZM1023.83,527.36v11.11l19.17,7.73h149.64s2.42-3.7,2.42-3.7v-2.42l-8.21-1.13-4.67-2.9-2.9-2.42-136.75.32-18.68-6.6ZM1202.3,546.21h8.86l-3.06-3.06h-5.15l-.64,3.06ZM260.53,370.48h-108.59v58.95l109.37-.68-.78-58.27Z",
    wallMasks: {
      front: "/assets/images/kitchen/front-wall.svg",
      left: "/assets/images/kitchen/left-wall.svg",
      back: "/assets/images/kitchen/back-wall.svg"
    }
  }
};

// JWT secret key (should be in environment variables in production)
const JWT_SECRET = process.env.JWT_SECRET || 'your-super-secret-key-change-in-production';

// Generate access token with expiration
function generateAccessToken(data: any) {
  return jwt.sign(
    { 
      ...data, 
      exp: Math.floor(Date.now() / 1000) + (5 * 60) // 5 minutes expiry
    },
    JWT_SECRET
  );
}

// Verify access token
function verifyAccessToken(token: string) {
  try {
    return jwt.verify(token, JWT_SECRET);
  } catch (error) {
    return null;
  }
}

// Server-side color processing logic (protected)
function processColorData(roomType: string, colors: string[]) {
  const roomData = PROTECTED_ROOM_DATA[roomType as keyof typeof PROTECTED_ROOM_DATA];
  if (!roomData) return null;

  // Complex color processing logic (now hidden from client)
  const processedColors = colors.map(color => {
    // Add color validation, contrast calculations, etc.
    return {
      hex: color,
      rgb: hexToRgb(color),
      contrast: calculateContrast(color),
      luminance: calculateLuminance(color)
    };
  });

  return {
    roomType,
    svgPath: roomData.svgPath,
    image: roomData.image,
    wallMasks: roomData.wallMasks,
    processedColors,
    timestamp: Date.now()
  };
}

// Helper functions (server-side only)
function hexToRgb(hex: string) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

function calculateContrast(color: string) {
  // Simplified contrast calculation
  const rgb = hexToRgb(color);
  if (!rgb) return 0;
  return (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
}

function calculateLuminance(color: string) {
  // Simplified luminance calculation
  const rgb = hexToRgb(color);
  if (!rgb) return 0;
  return 0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b;
}

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  // Only accept POST requests
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { roomType, colors, token } = req.body;

    // Validate input
    if (!roomType || !colors || !Array.isArray(colors)) {
      return res.status(400).json({ error: 'Invalid input parameters' });
    }

    // Verify token if provided (optional for now)
    if (token) {
      const tokenData = verifyAccessToken(token);
      if (!tokenData) {
        return res.status(401).json({ error: 'Invalid or expired token' });
      }
    }

    // Check if room type exists
    if (!PROTECTED_ROOM_DATA[roomType as keyof typeof PROTECTED_ROOM_DATA]) {
      return res.status(400).json({ error: 'Invalid room type' });
    }

    // Process the data server-side
    const processedData = processColorData(roomType, colors);
    
    if (!processedData) {
      return res.status(500).json({ error: 'Failed to process room data' });
    }

    // Generate new token for next request
    const newToken = generateAccessToken({ roomType, timestamp: Date.now() });

    // Return processed data
    res.status(200).json({
      success: true,
      data: processedData,
      nextToken: newToken
    });

  } catch (error) {
    console.error('Room data API error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
}